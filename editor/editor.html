<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="viewport" content="user-scalable=1.0,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="format-detection" content="telephone=no">

	<title>Photo Paint</title>
	<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
	<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
	
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
    
	<script src="../colorSlider/colorSlider.js"></script>
	<script src="js/filter.js"></script>

	<link href='https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css' rel='stylesheet' type='text/css'>
	<link href='../colorSlider/colorSlider.css' rel='stylesheet' type='text/css'>
	
	<script src="js/jquery.ui.touch-punch.min.js"></script>

	 <style>
      body {
         background: black;
         font-family: tahoma, verdana, sans serif;
				 height: 100%;
				 overflow: auto;
				 -webkit-overflow-scrolling: touch;
      }
			img{
				position: absolute;
				bottom: 10px;
				display: none;
			}
      #mainCanvas {
         position:absolute;
         z-index: 0;
         left: 10px;
         top: 10px;
         box-shadow: 4px 4px 8px rgba(0,0,0,0.5);
      }
			#tmpCanvas {
				 position:absolute;
				 z-index: -2;
				 left: 10px;
				 top: 10px;
				 cursor: crosshair;
			}
			#pictureCanvas {
				position:absolute;
				z-index: -1;
				left: 10px;
				top: 10px;
			}
       #controls {
         position: absolute;
         z-index: 2;
         left: 25px;
         top: 25px;
      }
      label{
      	font-size: 12px;
      	margin-right:0.75em;
      }
    </style>
</head>
<body>
	<canvas id="mainCanvas" width="700" height="500">
	Get a real browser!
	</canvas>
	<canvas id="tmpCanvas" width="700" height="500">
	Get a real browser!
	</canvas>

	<canvas id="pictureCanvas">
		Get a real browser!
	</canvas>

	<img id="img" src="images/leaf.jpg">

	<div id="controls">

			<div id="coloredSlider"></div>
			<script>$('#coloredSlider').draggable();</script>

			<label>Line Width:
        <select id="lineWidthChooser">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3" selected>3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
        </select>
      </label>

    	<span><input id="clearButton" type="button" value="Clear"/></span>
    	<span><input id="exportButton" type="button" value="Export"/></span>
			<span><input id="addPicture" type="button" value="Add Picture"/></span>
			<span><input id="undoButton" type="button" value="Undo"/></span>
			<span><input id="redoButton" type="button" value="Redo"/></span>
			<span><input id="grayscaleFilter" type="button" value="Black and White"/></span>
			<span><input id="invertFilter" type="button" value="Invert"/></span>
			<span><input id="redFilter" type="button" value="Red"/></span>
			<span><input id="blueFilter" type="button" value="Blue"/></span>
			<span><input id="greenFilter" type="button" value="Green"/></span>
			<span><input id="noFilter" type="button" value="No Filter"/></span>
    </div>

		<script>
		"use strict";

		// Enable fastclick library
    if ('addEventListener' in document) {
        document.addEventListener('DOMContentLoaded', function() {
            FastClick.attach(document.body);
        }, false);
    }

		window.onload = init;
		// GLOBALS
		var canvas,ctx,dragging=false,lineWidth,strokeStyle;
		var tmpCanvas, tmpCtx;
		var picCanvas, picCtx;
		var img;

		// Pencil Points
		var ppts = [];

		//making array for undo button. Picture the canvas everytime when the touch is release.
		var canvasPushArray = new Array();
		var canvasStep = -1;
		// CONSTANTS
		var DEFAULT_LINE_WIDTH = 3;
		var DEFAULT_STROKE_STYLE = "red";

		// FUNCTIONS
		function init(){
			// initialize some globals
			canvas = document.querySelector('#mainCanvas');
			ctx = canvas.getContext('2d');
			tmpCanvas = document.querySelector('#tmpCanvas');
			tmpCtx = tmpCanvas.getContext('2d');
			picCanvas = document.querySelector('#pictureCanvas');
			picCtx = picCanvas.getContext('2d');
			img = document.querySelector('#img');
			lineWidth = DEFAULT_LINE_WIDTH;
			strokeStyle = DEFAULT_STROKE_STYLE;
			//set initial properties of the graphics context
			ctx.lineWidth = lineWidth;
			ctx.strokeStyle = strokeStyle;
			ctx.lineCap = "round"; // "butt", "round", "square" (default "butt")
			ctx.lineJoin = "round"; // "round", "bevel", "miter" (default "miter")

			//FIX THIS PAINTING COLOR
			tmpCtx.lineWidth = lineWidth;
			tmpCtx.lineJoin = 'round';
			tmpCtx.lineCap = 'round';
			tmpCtx.strokeStyle = strokeStyle;

			resizeCanvas();
			// Hook up event listeners
			canvas.addEventListener('touchstart', doTouchdown);
			canvas.addEventListener('touchmove', doTouchmove);
			canvas.addEventListener('touchend', doTouchup);
			canvas.addEventListener('touchcancel', doTouchout);
	    document.querySelector('#lineWidthChooser').onchange = doLineWidthChange;
			document.querySelector('#exportButton').onclick = doExport;
			document.querySelector('#clearButton').onclick = doClear;
			document.querySelector('#addPicture').onclick = addPicture;
			document.querySelector('#undoButton').onclick = canvasUndo;
			document.querySelector('#redoButton').onclick = canvasRedo;
			document.querySelector('#invertFilter').onclick = invertFilter;
			document.querySelector('#grayscaleFilter').onclick = grayscaleFilter;
			document.querySelector('#redFilter').onclick = redFilter;
			document.querySelector('#blueFilter').onclick = blueFilter;
			document.querySelector('#greenFilter').onclick = greenFilter;
			document.querySelector('#noFilter').onclick = noFilter;

			//push a blank canvas
			canvasPush();
		}
		// EVENT CALLBACK FUNCTIONS
		function doLineWidthChange(e){
		lineWidth = e.target.value;
		}
		function doTouchdown(e){
			console.log(e.type);
			dragging = true;
			// get location of mouse in canvas coordinates
			var touch = getTouch(e);
			ppts.push({x:touch.x, y:touch.y});
			console.log(ppts);
			onPaint(e);
		}
		function doTouchmove(e) {
			// bail out if the touch button is not down
			if(!dragging) return;
			// get location of touch in canvas coordinates
			var touch = getTouchCoords(e, canvas);
			ppts.push({x:touch.x, y:touch.y});
			console.log(ppts);
			onPaint(e);
		}
		//when the touch is up, push the canvas to the canvasPushArray and stop dragging
		function doTouchup(e) {
			console.log(e.type);
			//drawing tmp Canvas to the main canvas
			ctx.drawImage(tmpCanvas, 0, 0);
			//clearing tmp canvas
			//tmpCtx.clearRect(0, 0, tmpCanvas.width, tmpCanvas.height);
			//emptying the pencil points
			ppts = [];

			dragging = false;
			canvasPush();
		}
		// if the user drags out of the canvas
		function doTouchout(e) {
			console.log(e.type);
			//ctx.closePath();
			dragging = false;
		}

		var onPaint = function(e) {
			var touch = getTouchCoords(e, canvas);
			//ppts.push({x:touch.x, y:touch.y});

			if (ppts.length < 3){
				var b = ppts[0];
				tmpCtx.beginPath();
				tmpCtx.arc(b.x, b.y, tmpCtx.lineWidth / 2, 0, Math.PI * 2, !0);
				tmpCtx.fill();
				tmpCtx.closePath();

				return;
			}

			// tmp canvas need to clear canvas before drawing
			tmpCtx.clearRect(0, 0, tmpCanvas.width, tmpCanvas.height);

			tmpCtx.beginPath();
			tmpCtx.moveTo(ppts[0].x, ppts[0].y);

			for (var i = 1; i < ppts.length -2; i++) {
				var c = (ppts[i].x + ppts[i + 1].x) / 2;
				var d = (ppts[i].y + ppts[i + 1].y) / 2;

				tmpCtx.quadraticCurveTo(ppts[i].x, ppts[i].y, c, d);
			}

			// For the last 2 points
			tmpCtx.quadraticCurveTo(
				ppts[i].x,
				ppts[i].y,
				ppts[i + 1].x,
				ppts[i + 1].y
			);
			// set ctx.strokeStyle and ctx.lineWidth to correct global values
			tmpCtx.strokeStyle = strokeStyle;
			tmpCtx.lineWidth = lineWidth;
			tmpCtx.stroke();
			console.log("paint as been call");
		};

		function doClear(){
			ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
		}
		function doExport(){
			// open a new window and load the image in it
			// http://www.w3schools.com/jsref/met_win_open.asp
			picCtx.drawImage(canvas,0,0);
			var data = picCanvas.toDataURL();
			//add code here to sent final picture to the server
			console.log(data);
			var windowName = "canvasImage";
			var windowOptions = "left=0,top=0,width=" + canvas.width + ",height=" + canvas.height +",toolbar=0,resizable=0";
			var myWindow = window.open(data,windowName,windowOptions);
			myWindow.resizeTo(canvas.width,canvas.height); // needed so Chrome would display image
		}
		// UTILITY FUNCTIONS
		// returns touch position in local coordinate system of element
		function getTouch(e){
			var touch = {};
			touch.x = e.pageX - e.target.offsetLeft;
			touch.y = e.pageY - e.target.offsetTop;
			return touch;
		}
		function getTouchCoords(e, canvas){
			var touch = {}
			touch.x = e.touches[0].pageX - canvas.offsetLeft;
			touch.y = e.touches[0].pageY - canvas.offsetTop;
			return touch;
		}
		function addPicture(){
			picCtx.drawImage(img,0,0);
			console.log(img);
		}
		function resizeCanvas() {
			ctx.canvas.width  = window.innerWidth - 30;
			ctx.canvas.height = window.innerHeight - 30;
			tmpCtx.canvas.height = window.innerHeight -30;
			tmpCtx.canvas.width = window.innerWidth -30;
			picCtx.canvas.width  = window.innerWidth - 30;
			picCtx.canvas.height = window.innerHeight - 30;
		}
		window.onresize = resizeCanvas;
		//undo function for painting below
		//push current canvas to canvas array
		function canvasPush(){
			canvasStep++;
			if (canvasStep < canvasPushArray.length)
				{
					canvasPushArray.length = canvasStep;
				}
			canvasPushArray.push(canvas.toDataURL());
		}
		//load previous canvas from canvasPushArray
		function canvasUndo(){
			if (canvasStep > 0){
				canvasStep--;
				var canvasImage = new Image();
				canvasImage.src = canvasPushArray[canvasStep];
				doClear();
				canvasImage.onload = function() {ctx.drawImage(canvasImage,0,0);}
			}
		}
    //load after current canvas from canvasPushArray
		function canvasRedo(){
			if (canvasStep < canvasPushArray.length-1){
				canvasStep++;
				var canvasImage = new Image();
				doClear();
				canvasImage.src = canvasPushArray[canvasStep];
				canvasImage.onload = function() {ctx.drawImage(canvasImage,0,0);}
			}
		}
		</script>

<script src="./libs/inobounce.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
</body>
</html>
